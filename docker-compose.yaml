services:
  zammad-memcached:
    image: memcached:1.6.40-alpine
    restart: always
    command: memcached -m 256M

  zammad-postgresql:
    image: postgres:17.7-alpine
    restart: always
    environment:
      POSTGRES_DB: zammad_production
      POSTGRES_USER: zammad
      POSTGRES_PASSWORD: zammad
    volumes:
      - postgresql-data:/var/lib/postgresql/data

  zammad-redis:
    image: redis:7.4.7-alpine
    restart: always
    volumes:
      - redis-data:/data

  zammad-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.19.11
    restart: always
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      ES_JAVA_OPTS: "-Xms1g -Xmx1g"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data

  zammad-init:
    image: ghcr.io/zammad/zammad:6.5.2-85
    restart: on-failure
    user: "0:0"
    command: ["zammad-init"]
    depends_on:
      - zammad-memcached
      - zammad-postgresql
      - zammad-redis
      - zammad-elasticsearch
    environment:
      MEMCACHE_SERVERS: zammad-memcached:11211
      POSTGRESQL_DB: zammad_production
      POSTGRESQL_HOST: zammad-postgresql
      POSTGRESQL_USER: zammad
      POSTGRESQL_PASS: zammad
      POSTGRESQL_PORT: "5432"
      POSTGRESQL_OPTIONS: "?pool=50"
      POSTGRESQL_DB_CREATE: "true"
      REDIS_URL: redis://zammad-redis:6379

      ELASTICSEARCH_ENABLED: "true"
      ELASTICSEARCH_SCHEMA: "http"
      ELASTICSEARCH_HOST: "zammad-elasticsearch"
      ELASTICSEARCH_PORT: "9200"
      ELASTICSEARCH_NAMESPACE: "zammad"
      ELASTICSEARCH_REINDEX: "true"

      TZ: America/Denver
      ZAMMAD_HTTP_TYPE: https
      ZAMMAD_FQDN: support.calderacyber.com
      RAILS_TRUSTED_PROXIES: 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
    volumes:
      - zammad-storage:/opt/zammad/storage

  zammad-railsserver:
    image: ghcr.io/zammad/zammad:6.5.2-85
    restart: always
    command: ["zammad-railsserver"]
    depends_on:
      - zammad-init
    environment:
      MEMCACHE_SERVERS: zammad-memcached:11211
      POSTGRESQL_DB: zammad_production
      POSTGRESQL_HOST: zammad-postgresql
      POSTGRESQL_USER: zammad
      POSTGRESQL_PASS: zammad
      POSTGRESQL_PORT: "5432"
      POSTGRESQL_OPTIONS: "?pool=50"
      REDIS_URL: redis://zammad-redis:6379

      ELASTICSEARCH_ENABLED: "true"
      ELASTICSEARCH_SCHEMA: "http"
      ELASTICSEARCH_HOST: "zammad-elasticsearch"
      ELASTICSEARCH_PORT: "9200"
      ELASTICSEARCH_NAMESPACE: "zammad"

      TZ: America/Denver
      ZAMMAD_HTTP_TYPE: https
      ZAMMAD_FQDN: support.calderacyber.com
      RAILS_TRUSTED_PROXIES: 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
    volumes:
      - zammad-storage:/opt/zammad/storage

  zammad-scheduler:
    image: ghcr.io/zammad/zammad:6.5.2-85
    restart: always
    command: ["zammad-scheduler"]
    depends_on:
      - zammad-railsserver
    environment:
      MEMCACHE_SERVERS: zammad-memcached:11211
      POSTGRESQL_DB: zammad_production
      POSTGRESQL_HOST: zammad-postgresql
      POSTGRESQL_USER: zammad
      POSTGRESQL_PASS: zammad
      POSTGRESQL_PORT: "5432"
      POSTGRESQL_OPTIONS: "?pool=50"
      REDIS_URL: redis://zammad-redis:6379

      ELASTICSEARCH_ENABLED: "true"
      ELASTICSEARCH_SCHEMA: "http"
      ELASTICSEARCH_HOST: "zammad-elasticsearch"
      ELASTICSEARCH_PORT: "9200"
      ELASTICSEARCH_NAMESPACE: "zammad"

      TZ: America/Denver
    volumes:
      - zammad-storage:/opt/zammad/storage

  zammad-websocket:
    image: ghcr.io/zammad/zammad:6.5.2-85
    restart: always
    command: ["zammad-websocket"]
    depends_on:
      - zammad-railsserver
    environment:
      MEMCACHE_SERVERS: zammad-memcached:11211
      POSTGRESQL_DB: zammad_production
      POSTGRESQL_HOST: zammad-postgresql
      POSTGRESQL_USER: zammad
      POSTGRESQL_PASS: zammad
      POSTGRESQL_PORT: "5432"
      POSTGRESQL_OPTIONS: "?pool=50"
      REDIS_URL: redis://zammad-redis:6379

      ELASTICSEARCH_ENABLED: "true"
      ELASTICSEARCH_SCHEMA: "http"
      ELASTICSEARCH_HOST: "zammad-elasticsearch"
      ELASTICSEARCH_PORT: "9200"
      ELASTICSEARCH_NAMESPACE: "zammad"

      TZ: America/Denver
    volumes:
      - zammad-storage:/opt/zammad/storage

  zammad-nginx:
    image: ghcr.io/zammad/zammad:6.5.2-85
    restart: always
    command: ["zammad-nginx"]
    depends_on:
      - zammad-railsserver
    ports:
      - "8080:8080"
    environment:
      MEMCACHE_SERVERS: zammad-memcached:11211
      POSTGRESQL_DB: zammad_production
      POSTGRESQL_HOST: zammad-postgresql
      POSTGRESQL_USER: zammad
      POSTGRESQL_PASS: zammad
      POSTGRESQL_PORT: "5432"
      POSTGRESQL_OPTIONS: "?pool=50"
      REDIS_URL: redis://zammad-redis:6379

      ELASTICSEARCH_ENABLED: "true"
      ELASTICSEARCH_SCHEMA: "http"
      ELASTICSEARCH_HOST: "zammad-elasticsearch"
      ELASTICSEARCH_PORT: "9200"
      ELASTICSEARCH_NAMESPACE: "zammad"

      NGINX_PORT: "8080"
      NGINX_CLIENT_MAX_BODY_SIZE: "50m"
      NGINX_SERVER_NAME: support.calderacyber.com
      NGINX_SERVER_SCHEME: https

      TZ: America/Denver
      ZAMMAD_HTTP_TYPE: https
      ZAMMAD_FQDN: support.calderacyber.com
      RAILS_TRUSTED_PROXIES: 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
    volumes:
      - zammad-storage:/opt/zammad/storage

  zammad-backup:
    image: ghcr.io/zammad/zammad:6.5.2-85
    restart: always
    user: "0:0"
    command: ["zammad-backup"]
    depends_on:
      - zammad-railsserver
    environment:
      BACKUP_DIR: /var/tmp/zammad
      BACKUP_TIME: "03:00"
      HOLD_DAYS: "10"
      TZ: America/Denver
      POSTGRESQL_DB: zammad_production
      POSTGRESQL_HOST: zammad-postgresql
      POSTGRESQL_USER: zammad
      POSTGRESQL_PASS: zammad
      POSTGRESQL_PORT: "5432"
      REDIS_URL: redis://zammad-redis:6379
    volumes:
      - zammad-backup:/var/tmp/zammad
      - zammad-storage:/opt/zammad/storage:ro

volumes:
  postgresql-data:
  redis-data:
  zammad-storage:
  zammad-backup:
  elasticsearch-data:
